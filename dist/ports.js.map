{"version":3,"file":"ports.js","sources":["src/ports.js"],"sourcesContent":["/* globals Elm, $ */\n/* eslint-disable new-cap, no-underscore-dangle */\n\n(function () {\n  /**\n   * If it's not a Maybe, returns whatever value that is, if it is\n   * a Maybe, returns `value` for `Just value` and `null` for `Nothing`\n   * @method fromMaybe\n   * @param  {Object<Any> | Any } val\n   * @return {Any}\n   */\n  const fromMaybe = val => {\n    const isMaybe = val && val.ctor;\n\n    if (!isMaybe) {\n      return val;\n    }\n\n    return val._0 ? val._0 : null;\n  };\n\n  const parseElmList = l => {\n    if (Array.isArray(l)) {\n      return l;\n    }\n\n    let list = [];\n    let counter = 0;\n    let key = `_${counter}`;\n    while (l[key] !== undefined && l[key].ctor !== '[]') {\n      list = list.concat(l[key]);\n      counter = counter + 1;\n      key = `_${counter}`;\n    }\n\n    return list;\n  };\n\n  /**\n   * Creates an Elm acceptable Modal object\n   * @method Modal\n   * @param  {String} selector\n   * @param  {String | Maybe String} targetUrl\n   */\n  const Modal = function ({ selector, targetUrl } = {}) {\n    if (!selector) {\n      // It was not set by Elm\n      return null;\n    }\n\n    const url = fromMaybe(targetUrl);\n    return { selector, targetUrl: url };\n  };\n\n  /**\n   * Creates an Elm acceptable HistoryState object\n   * This is used to make the link Elm-JS and JS-Elm\n   * @method HistoryState\n   * @param  {String} url\n   * @param  {Array<Modal>}\n   */\n  const HistoryState = function (state) {\n    const { url, openModals, sessionId } = state || {};\n    if (!url) {\n      // It was not set by Elm\n      return null;\n    }\n\n    const modals = parseElmList(openModals).map(Modal);\n    modals.forEach(m => {\n      if (!m) {\n        throw new Error(\n          'A null modal was found in a history state. '\n          + `Something is wrong. Here are all the modals ${JSON.stringify(modals)}`\n        );\n      }\n    });\n    return { url, sessionId, openModals: modals };\n  };\n\n  // =============================================================================\n\n  // We will provide a unique id for our app\n  const sessionId = Date.now();\n  const app = Elm.ModalRouter.fullscreen(sessionId);\n\n  // We send stuff to Elm with suggestions\n  const {\n    onPopState,\n    onModalOpen,\n    onModalClose,\n  } = app.ports;\n\n  window.addEventListener('popstate', (e) => {\n    const histState = HistoryState(e.state);\n    onPopState.send(histState);\n  });\n\n  function getModalInfo(e) {\n    const targetUrl = e.relatedTarget && e.relatedTarget.getAttribute('href')\n        ? e.relatedTarget.getAttribute('href')\n        : null;\n\n    const selector = `#${e.target.id}`;\n    const modalInfo = Modal({ selector, targetUrl });\n    return modalInfo;\n  }\n\n  $(document.body)\n    .on('show.bs.modal', (e) => onModalOpen.send(getModalInfo(e)))\n    .on('hide.bs.modal', (e) => {\n      const modal = getModalInfo(e);\n      if (!modal) {\n        throw new Error('Modal close event did not contain a modal. Something is wrong.');\n      }\n      onModalClose.send(modal.selector);\n    });\n\n  app.ports.reload.subscribe(() => {\n    window.location.reload();\n  });\n}());\n"],"names":[],"mappings":";;;;;;;;;AAGC,aAAY;;;;;;;;MAQL,YAAY,SAAZ,SAAY,MAAO;QACjB,UAAU,OAAO,IAAI,IAA3B;;QAEI,CAAC,OAAL,EAAc;aACL,GAAP;;;WAGK,IAAI,EAAJ,GAAS,IAAI,EAAb,GAAkB,IAAzB;GAPF;;MAUM,eAAe,SAAf,YAAe,IAAK;QACpB,MAAM,OAAN,CAAc,CAAd,CAAJ,EAAsB;aACb,CAAP;;;QAGE,OAAO,EAAX;QACI,UAAU,CAAd;QACI,YAAU,OAAd;WACO,EAAE,GAAF,MAAW,SAAX,IAAwB,EAAE,GAAF,EAAO,IAAP,KAAgB,IAA/C,EAAqD;aAC5C,KAAK,MAAL,CAAY,EAAE,GAAF,CAAZ,CAAP;gBACU,UAAU,CAApB;kBACU,OAAV;;;WAGK,IAAP;GAdF;;;;;;;;MAuBM,QAAQ,SAAR,KAAQ,GAAwC;mFAAJ,EAAI;;QAA5B,QAA4B,QAA5B,QAA4B;QAAlB,SAAkB,QAAlB,SAAkB;;QAChD,CAAC,QAAL,EAAe;;aAEN,IAAP;;;QAGI,MAAM,UAAU,SAAV,CAAZ;WACO,EAAE,kBAAF,EAAY,WAAW,GAAvB,EAAP;GAPF;;;;;;;;;MAiBM,eAAe,SAAf,YAAe,CAAU,KAAV,EAAiB;gBACG,SAAS,EADZ;;QAC5B,GAD4B,SAC5B,GAD4B;QACvB,UADuB,SACvB,UADuB;QACX,SADW,SACX,SADW;;QAEhC,CAAC,GAAL,EAAU;;aAED,IAAP;;;QAGI,SAAS,aAAa,UAAb,EAAyB,GAAzB,CAA6B,KAA7B,CAAf;WACO,OAAP,CAAe,aAAK;UACd,CAAC,CAAL,EAAQ;cACA,IAAI,KAAJ,CACJ,kGACiD,KAAK,SAAL,CAAe,MAAf,CADjD,CADI,CAAN;;KAFJ;WAQO,EAAE,QAAF,EAAO,oBAAP,EAAkB,YAAY,MAA9B,EAAP;GAhBF;;;;;MAsBM,YAAY,KAAK,GAAL,EAAlB;MACM,MAAM,IAAI,WAAJ,CAAgB,UAAhB,CAA2B,SAA3B,CAAZ;;;mBAOI,IAAI,KAxFG;MAqFT,UArFS,cAqFT,UArFS;MAsFT,WAtFS,cAsFT,WAtFS;MAuFT,YAvFS,cAuFT,YAvFS;;;SA0FJ,gBAAP,CAAwB,UAAxB,EAAoC,UAAC,CAAD,EAAO;QACnC,YAAY,aAAa,EAAE,KAAf,CAAlB;eACW,IAAX,CAAgB,SAAhB;GAFF;;WAKS,YAAT,CAAsB,CAAtB,EAAyB;QACjB,YAAY,EAAE,aAAF,IAAmB,EAAE,aAAF,CAAgB,YAAhB,CAA6B,MAA7B,CAAnB,GACZ,EAAE,aAAF,CAAgB,YAAhB,CAA6B,MAA7B,CADY,GAEZ,IAFN;;QAIM,iBAAe,EAAE,MAAF,CAAS,EAA9B;QACM,YAAY,MAAM,EAAE,kBAAF,EAAY,oBAAZ,EAAN,CAAlB;WACO,SAAP;;;IAGA,SAAS,IAAX,EACG,EADH,CACM,eADN,EACuB,UAAC,CAAD;WAAO,YAAY,IAAZ,CAAiB,aAAa,CAAb,CAAjB,CAAP;GADvB,EAEG,EAFH,CAEM,eAFN,EAEuB,UAAC,CAAD,EAAO;QACpB,QAAQ,aAAa,CAAb,CAAd;QACI,CAAC,KAAL,EAAY;YACJ,IAAI,KAAJ,CAAU,gEAAV,CAAN;;iBAEW,IAAb,CAAkB,MAAM,QAAxB;GAPJ;;MAUI,KAAJ,CAAU,MAAV,CAAiB,SAAjB,CAA2B,YAAM;WACxB,QAAP,CAAgB,MAAhB;GADF;CAnHD,GAAD;;"}